<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gap Analysis Tool</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Bibliotecas necesarias -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom, #f9fafb, #ffffff);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    .header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 1.5rem 0;
      margin-bottom: 2rem;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    h1 { font-size: 2rem; font-weight: 700; color: #111827; }
    h2 { font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 1rem; }
    h3 { font-size: 1.25rem; font-weight: 600; color: #111827; margin-bottom: 0.5rem; }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #111827;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #1f2937;
    }
    
    .btn-secondary {
      background: white;
      color: #111827;
      border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #f9fafb;
    }
    
    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
    
    .card {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      margin-bottom: 1.5rem;
    }
    
    .card:hover {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .grid {
      display: grid;
      gap: 2rem;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
    
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 50;
    }
    
    .modal {
      background: white;
      border-radius: 0.75rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #374151;
    }
    
    input[type="text"],
    input[type="file"],
    select,
    textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: inherit;
    }
    
    textarea {
      min-height: 150px;
      resize: vertical;
    }
    
    .hidden {
      display: none !important;
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .badge-gray {
      background: #f3f4f6;
      color: #374151;
    }
    
    .badge-yellow {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge-red {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .badge-green {
      background: #d1fae5;
      color: #065f46;
    }
    
    .loader {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #111827;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .analysis-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .gap-item {
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-top: 0.5rem;
    }
    
    .icon {
      font-size: 1.5rem;
    }
    
    .text-gray { color: #6b7280; }
    .text-sm { font-size: 0.875rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mt-4 { margin-top: 1rem; }
    .flex { display: flex; }
    .gap-2 { gap: 0.5rem; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script>
    // ============================================================
    // CONFIGURACI√ìN
    // ============================================================
    
    const CONFIG = {
      mistralApiKey: 'mAG1EEnyOQjfy5oQ3WPv2wTay0DV9Jhw',
      firebase: {
        apiKey: "AIzaSyDUZR1huz-XHFQBI2CnRGDMxg_f3kFErPA",
        authDomain: "gapanalysis-8b408.firebaseapp.com",
        projectId: "gapanalysis-8b408",
        storageBucket: "gapanalysis-8b408.firebasestorage.app",
        messagingSenderId: "48683423858",
        appId: "1:48683423858:web:7ca2267a11f448b2864aeb"
      }
    };
    
    let db = null;
    let currentPage = 'home';
    let currentData = {
      frameworks: [],
      analisis: [],
      currentAnalisisId: null
    };
    
    // ============================================================
    // FIREBASE INIT
    // ============================================================
    
    try {
      firebase.initializeApp(CONFIG.firebase);
      db = firebase.firestore();
      console.log('‚úÖ Firestore activo');
    } catch (error) {
      console.error('‚ùå Error Firebase:', error);
      alert('Error al conectar con Firebase: ' + error.message);
    }
    
    // ============================================================
    // DATA STORE
    // ============================================================
    
    const DataStore = {
      async saveFramework(fw) {
        if (db) {
          const ref = db.collection('frameworks');
          if (fw.id) {
            await ref.doc(fw.id).set(fw);
            return fw;
          } else {
            const doc = await ref.add(fw);
            return { ...fw, id: doc.id };
          }
        } else {
          const all = JSON.parse(localStorage.getItem('frameworks') || '[]');
          if (!fw.id) fw.id = Date.now().toString();
          const idx = all.findIndex(f => f.id === fw.id);
          if (idx >= 0) all[idx] = fw;
          else all.push(fw);
          localStorage.setItem('frameworks', JSON.stringify(all));
          return fw;
        }
      },
      
      async getFrameworks() {
        if (db) {
          const snap = await db.collection('frameworks').get();
          return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        } else {
          return JSON.parse(localStorage.getItem('frameworks') || '[]');
        }
      },
      
      async deleteFramework(id) {
        if (db) {
          await db.collection('frameworks').doc(id).delete();
        } else {
          const all = JSON.parse(localStorage.getItem('frameworks') || '[]');
          localStorage.setItem('frameworks', JSON.stringify(all.filter(f => f.id !== id)));
        }
      },
      
      async saveAnalisis(a) {
        if (db) {
          const ref = db.collection('analisis');
          if (a.id) {
            await ref.doc(a.id).set(a);
            return a;
          } else {
            const doc = await ref.add(a);
            return { ...a, id: doc.id };
          }
        } else {
          const all = JSON.parse(localStorage.getItem('analisis') || '[]');
          if (!a.id) a.id = Date.now().toString();
          const idx = all.findIndex(x => x.id === a.id);
          if (idx >= 0) all[idx] = a;
          else all.push(a);
          localStorage.setItem('analisis', JSON.stringify(all));
          return a;
        }
      },
      
      async getAnalisis() {
        if (db) {
          const snap = await db.collection('analisis').get();
          return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        } else {
          return JSON.parse(localStorage.getItem('analisis') || '[]');
        }
      }
    };
    
    // ============================================================
    // UTILITIES
    // ============================================================
    
    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            const categorias = [];
            let currentCat = null;
            let currentElem = null;
            
            rows.slice(1).forEach((row, i) => {
              const catText = row[0]?.toString().trim();
              const elemText = row[1]?.toString().trim();
              const indText = row[2]?.toString().trim();
              
              if (catText) {
                if (currentCat && currentElem) currentCat.elementos.push(currentElem);
                if (currentCat) categorias.push(currentCat);
                currentCat = { id: \`cat-\${Date.now()}-\${i}\`, nombre: catText, elementos: [] };
                currentElem = null;
              }
              if (elemText && currentCat) {
                if (currentElem) currentCat.elementos.push(currentElem);
                currentElem = { id: \`elem-\${Date.now()}-\${i}\`, nombre: elemText, indicaciones: [] };
              }
              if (indText && currentElem) {
                currentElem.indicaciones.push({ id: \`ind-\${Date.now()}-\${i}\`, texto: indText });
              }
            });
            
            if (currentCat && currentElem) currentCat.elementos.push(currentElem);
            if (currentCat) categorias.push(currentCat);
            
            resolve({ nombre: file.name.replace(/\.(xlsx|xls)$/, ''), categorias });
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = () => reject(reader.error);
        reader.readAsArrayBuffer(file);
      });
    }
    
    async function analyzeWithMistral(indicacion, documentos) {
      const docsText = documentos.map(d => \`Documento: \${d.nombre}\`).join('\\n');
      const prompt = \`Eres un analista experto. Analiza en relaci√≥n con este criterio:

CRITERIO: \${indicacion}

DOCUMENTOS:
\${docsText}

Responde en JSON:
{
  "propuestaRespuesta": "an√°lisis breve",
  "gapsDetectados": ["gap1"],
  "confianza": 0.85
}\`;

      try {
        const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': \`Bearer \${CONFIG.mistralApiKey}\`
          },
          body: JSON.stringify({
            model: 'mistral-small-latest',
            messages: [{ role: 'user', content: prompt }]
          })
        });
        
        const data = await response.json();
        const content = data.choices?.[0]?.message?.content || '';
        const jsonMatch = content.match(/\{[\\s\\S]*\}/);
        if (jsonMatch) return JSON.parse(jsonMatch[0]);
        return { propuestaRespuesta: content, gapsDetectados: [], confianza: 0.5 };
      } catch (error) {
        console.error('Mistral error:', error);
        return { propuestaRespuesta: 'Error al analizar', gapsDetectados: [], confianza: 0 };
      }
    }
    
    async function exportToWord(analisis, framework) {
      try {
        const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;
        
        const children = [
          new Paragraph({ text: \`Informe: \${analisis.nombre}\`, heading: HeadingLevel.TITLE }),
          new Paragraph({ text: \`Framework: \${framework.nombre}\`, heading: HeadingLevel.HEADING_2 }),
          new Paragraph({ text: \`Fecha: \${new Date().toLocaleDateString('es-ES')}\` }),
          new Paragraph({ text: '' })
        ];
        
        framework.categorias.forEach(cat => {
          children.push(new Paragraph({ text: cat.nombre, heading: HeadingLevel.HEADING_2 }));
          cat.elementos.forEach(elem => {
            children.push(new Paragraph({ text: elem.nombre, heading: HeadingLevel.HEADING_3 }));
            elem.indicaciones.forEach(ind => {
              const resp = analisis.respuestas.find(r => r.indicacionId === ind.id);
              if (resp) {
                children.push(
                  new Paragraph({ children: [new TextRun({ text: 'Indicaci√≥n: ', bold: true }), new TextRun(ind.texto)] }),
                  new Paragraph({ children: [new TextRun({ text: 'Respuesta: ', bold: true }), new TextRun(resp.respuestaFinal || resp.propuestaIA)] })
                );
                if (resp.gaps?.length > 0) {
                  children.push(new Paragraph({ children: [new TextRun({ text: 'Gaps: ', bold: true, color: 'FF0000' })] }));
                  resp.gaps.forEach(gap => children.push(new Paragraph({ text: \`  ‚Ä¢ \${gap}\` })));
                }
              }
            });
          });
        });
        
        const doc = new Document({ sections: [{ children }] });
        const blob = await Packer.toBlob(doc);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = \`Analisis_\${analisis.nombre.replace(/[^a-z0-9]/gi, '_')}.docx\`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('Documento descargado');
      } catch (error) {
        console.error('Export error:', error);
        alert('Error al exportar: ' + error.message);
      }
    }
    
    // ============================================================
    // RENDERING FUNCTIONS  
    // ============================================================
    
    function render() {
      const app = document.getElementById('app');
      
      if (currentPage === 'home') {
        app.innerHTML = renderHome();
      } else if (currentPage === 'frameworks') {
        app.innerHTML = renderFrameworks();
      } else if (currentPage === 'analysis') {
        app.innerHTML = renderAnalysisList();
      } else if (currentPage === 'analysis-detail') {
        app.innerHTML = renderAnalysisDetail();
      }
      
      attachEventListeners();
    }
    
    function renderHome() {
      return \`
        <div class="header">
          <div class="header-content">
            <h1>üéØ Gap Analysis Tool</h1>
          </div>
        </div>
        <div class="container">
          <div class="grid">
            <div class="card" onclick="navigateTo('frameworks')">
              <div class="icon mb-4">üìÅ</div>
              <h2>Frameworks</h2>
              <p class="text-gray">Gestiona tus plantillas de an√°lisis desde Excel</p>
            </div>
            <div class="card" onclick="navigateTo('analysis')">
              <div class="icon mb-4">üìÑ</div>
              <h2>An√°lisis</h2>
              <p class="text-gray">Crea an√°lisis y genera reportes con IA</p>
            </div>
          </div>
        </div>
      \`;
    }
    
    function renderFrameworks() {
      const frameworks = currentData.frameworks;
      return \`
        <div class="header">
          <div class="header-content">
            <div class="flex items-center gap-2">
              <button class="btn btn-secondary btn-sm" onclick="navigateTo('home')">‚¨ÖÔ∏è Inicio</button>
              <h1>Frameworks</h1>
            </div>
            <button class="btn btn-primary" onclick="showNewFrameworkModal()">‚ûï Nuevo</button>
          </div>
        </div>
        <div class="container">
          \${frameworks.length === 0 ? \`
            <div class="card" style="text-align: center;">
              <h3>No hay frameworks</h3>
              <p class="text-gray mb-4">Crea tu primer framework desde un archivo Excel</p>
              <button class="btn btn-primary" onclick="showNewFrameworkModal()">Crear Framework</button>
            </div>
          \` : \`
            <div class="grid">
              \${frameworks.map(fw => \`
                <div class="card">
                  <h3>\${fw.nombre}</h3>
                  <p class="text-gray text-sm mb-4">\${fw.categorias.length} categor√≠as</p>
                  <button class="btn btn-secondary btn-sm" onclick="deleteFramework('\${fw.id}')">üóëÔ∏è Eliminar</button>
                </div>
              \`).join('')}
            </div>
          \`}
        </div>
      \`;
    }
    
    function renderAnalysisList() {
      const analisisList = currentData.analisis;
      const frameworks = currentData.frameworks;
      
      return \`
        <div class="header">
          <div class="header-content">
            <div class="flex items-center gap-2">
              <button class="btn btn-secondary btn-sm" onclick="navigateTo('home')">‚¨ÖÔ∏è Inicio</button>
              <h1>An√°lisis</h1>
            </div>
            <button class="btn btn-primary" onclick="showNewAnalysisModal()" \${frameworks.length === 0 ? 'disabled' : ''}>‚ûï Nuevo</button>
          </div>
        </div>
        <div class="container">
          \${frameworks.length === 0 ? \`
            <div class="card" style="text-align: center;">
              <h3>No hay frameworks</h3>
              <p class="text-gray mb-4">Primero crea un framework</p>
              <button class="btn btn-primary" onclick="navigateTo('frameworks')">Ir a Frameworks</button>
            </div>
          \` : analisisList.length === 0 ? \`
            <div class="card" style="text-align: center;">
              <h3>No hay an√°lisis</h3>
              <p class="text-gray mb-4">Crea tu primer an√°lisis</p>
              <button class="btn btn-primary" onclick="showNewAnalysisModal()">Crear An√°lisis</button>
            </div>
          \` : \`
            <div class="grid">
              \${analisisList.map(a => \`
                <div class="card" onclick="viewAnalysis('\${a.id}')">
                  <h3>\${a.nombre}</h3>
                  <p class="text-gray text-sm">\${a.frameworkNombre}</p>
                  <p class="text-gray text-sm mt-4">\${a.documentos?.length || 0} documentos</p>
                </div>
              \`).join('')}
            </div>
          \`}
        </div>
      \`;
    }
    
    function renderAnalysisDetail() {
      const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
      const framework = currentData.frameworks.find(f => f.id === analisis?.frameworkId);
      
      if (!analisis || !framework) {
        return '<div class="container"><div class="loader"></div></div>';
      }
      
      return \`
        <div class="header">
          <div class="header-content">
            <div>
              <div class="flex items-center gap-2 mb-4">
                <button class="btn btn-secondary btn-sm" onclick="navigateTo('analysis')">‚¨ÖÔ∏è Volver</button>
                <div>
                  <h1>\${analisis.nombre}</h1>
                  <p class="text-gray text-sm">\${framework.nombre}</p>
                </div>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-secondary btn-sm" onclick="exportAnalysis()">‚¨áÔ∏è Word</button>
            </div>
          </div>
        </div>
        <div class="container">
          <div class="card">
            <div class="flex justify-between items-center mb-4">
              <h3>Documentos (\${analisis.documentos?.length || 0})</h3>
              <label class="btn btn-secondary btn-sm" style="cursor: pointer;">
                <input type="file" multiple onchange="handleUploadDocs(event)" style="display: none;">
                Subir
              </label>
            </div>
            <div class="flex gap-2" style="flex-wrap: wrap;">
              \${(analisis.documentos || []).map(doc => \`
                <span class="badge badge-gray">\${doc.nombre}</span>
              \`).join('')}
            </div>
          </div>
          
          \${framework.categorias.map(cat => \`
            <div class="card">
              <h2>\${cat.nombre}</h2>
              \${cat.elementos.map(elem => \`
                <div style="margin-top: 1.5rem; padding-left: 1rem; border-left: 2px solid #e5e7eb;">
                  <h3>\${elem.nombre}</h3>
                  \${elem.indicaciones.map(ind => {
                    const resp = (analisis.respuestas || []).find(r => r.indicacionId === ind.id);
                    return \`
                      <div class="analysis-item">
                        <div class="flex justify-between items-start gap-2 mb-4">
                          <p class="text-sm flex-1"><strong>Indicaci√≥n:</strong> \${ind.texto}</p>
                          <div class="flex gap-2">
                            <button class="btn btn-secondary btn-sm" onclick="analyzeIndicacion('\${cat.id}', '\${elem.id}', '\${ind.id}', '\${ind.texto.replace(/'/g, "\\\\'")}')">
                              üîÑ
                            </button>
                            \${resp ? \`
                              <button class="btn btn-secondary btn-sm" onclick="editResponse('\${resp.id}')">
                                ‚úèÔ∏è Editar
                              </button>
                            \` : ''}
                          </div>
                        </div>
                        \${resp ? \`
                          <div style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                            <p class="text-sm text-gray mb-2">\${resp.respuestaFinal ? 'Respuesta Final:' : 'Propuesta IA:'}</p>
                            <p class="text-sm">\${resp.respuestaFinal || resp.propuestaIA}</p>
                          </div>
                          \${resp.gaps?.length > 0 ? \`
                            <div class="gap-item mt-4">
                              <p class="text-sm" style="font-weight: 600; color: #991b1b; margin-bottom: 0.5rem;">‚ö†Ô∏è Gaps:</p>
                              \${resp.gaps.map(gap => \`<p class="text-sm" style="color: #991b1b;">‚Ä¢ \${gap}</p>\`).join('')}
                            </div>
                          \` : ''}
                        \` : '<p class="text-sm text-gray" style="font-style: italic;">Pendiente</p>'}
                      </div>
                    \`;
                  }).join('')}
                </div>
              \`).join('')}
            </div>
          \`).join('')}
        </div>
      \`;
    }
    
    // ============================================================
    // EVENT HANDLERS
    // ============================================================
    
    function attachEventListeners() {
      // No needed for inline handlers
    }
    
    function navigateTo(page) {
      currentPage = page;
      render();
    }
    
    function showNewFrameworkModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = \`
        <div class="modal">
          <div class="modal-header">
            <h2>Nuevo Framework</h2>
            <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Nombre del Framework</label>
              <input type="text" id="fw-nombre" placeholder="Ej: ISO 27001">
            </div>
            <div class="form-group">
              <label>Archivo Excel</label>
              <input type="file" id="fw-file" accept=".xlsx,.xls">
            </div>
            <button class="btn btn-primary" onclick="createFramework()">Crear</button>
          </div>
        </div>
      \`;
      document.body.appendChild(modal);
    }
    
    async function createFramework() {
      const nombre = document.getElementById('fw-nombre').value;
      const file = document.getElementById('fw-file').files[0];
      
      if (!file) return alert('Selecciona un archivo Excel');
      
      try {
        const parsed = await parseExcel(file);
        const fw = {
          ...parsed,
          nombre: nombre || parsed.nombre,
          createdAt: new Date(),
          updatedAt: new Date()
        };
        
        const saved = await DataStore.saveFramework(fw);
        currentData.frameworks.push(saved);
        closeModal();
        navigateTo('frameworks');
      } catch (error) {
        alert('Error al cargar Excel: ' + error.message);
      }
    }
    
    async function deleteFramework(id) {
      if (!confirm('¬øEliminar framework?')) return;
      await DataStore.deleteFramework(id);
      currentData.frameworks = currentData.frameworks.filter(f => f.id !== id);
      render();
    }
    
    function showNewAnalysisModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = \`
        <div class="modal">
          <div class="modal-header">
            <h2>Nuevo An√°lisis</h2>
            <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Nombre del An√°lisis</label>
              <input type="text" id="an-nombre" placeholder="Ej: Auditor√≠a Q1 2024">
            </div>
            <div class="form-group">
              <label>Framework</label>
              <select id="an-framework">
                <option value="">Selecciona...</option>
                \${currentData.frameworks.map(fw => \`<option value="\${fw.id}">\${fw.nombre}</option>\`).join('')}
              </select>
            </div>
            <button class="btn btn-primary" onclick="createAnalysis()">Crear</button>
          </div>
        </div>
      \`;
      document.body.appendChild(modal);
    }
    
    async function createAnalysis() {
      const nombre = document.getElementById('an-nombre').value;
      const fwId = document.getElementById('an-framework').value;
      
      if (!nombre || !fwId) return alert('Completa todos los campos');
      
      const fw = currentData.frameworks.find(f => f.id === fwId);
      const newAnalisis = {
        nombre,
        frameworkId: fwId,
        frameworkNombre: fw.nombre,
        documentos: [],
        respuestas: [],
        status: 'borrador',
        createdAt: new Date()
      };
      
      const saved = await DataStore.saveAnalisis(newAnalisis);
      currentData.analisis.push(saved);
      currentData.currentAnalisisId = saved.id;
      closeModal();
      navigateTo('analysis-detail');
    }
    
    function viewAnalysis(id) {
      currentData.currentAnalisisId = id;
      navigateTo('analysis-detail');
    }
    
    async function handleUploadDocs(event) {
      const files = Array.from(event.target.files);
      const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
      
      const newDocs = files.map(f => ({
        id: \`doc-\${Date.now()}-\${Math.random()}\`,
        nombre: f.name,
        uploadedAt: new Date()
      }));
      
      analisis.documentos = [...(analisis.documentos || []), ...newDocs];
      await DataStore.saveAnalisis(analisis);
      render();
    }
    
    async function analyzeIndicacion(catId, elemId, indId, indTexto) {
      const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
      
      if (!analisis.documentos || analisis.documentos.length === 0) {
        return alert('Sube documentos primero');
      }
      
      const result = await analyzeWithMistral(indTexto, analisis.documentos);
      
      const newResp = {
        id: \`resp-\${Date.now()}\`,
        categoriaId: catId,
        elementoId: elemId,
        indicacionId: indId,
        propuestaIA: result.propuestaRespuesta,
        respuestaFinal: '',
        gaps: result.gapsDetectados,
        status: 'completado'
      };
      
      if (!analisis.respuestas) analisis.respuestas = [];
      const idx = analisis.respuestas.findIndex(r => r.indicacionId === indId);
      if (idx >= 0) analisis.respuestas[idx] = newResp;
      else analisis.respuestas.push(newResp);
      
      await DataStore.saveAnalisis(analisis);
      render();
    }
    
    function editResponse(respId) {
      const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
      const resp = analisis.respuestas.find(r => r.id === respId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = \`
        <div class="modal">
          <div class="modal-header">
            <h2>Editar Respuesta</h2>
            <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Propuesta IA:</label>
              <p class="text-sm text-gray" style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">\${resp.propuestaIA}</p>
            </div>
            <div class="form-group">
              <label>Respuesta Final:</label>
              <textarea id="edit-response">\${resp.respuestaFinal || resp.propuestaIA}</textarea>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
              <button class="btn btn-primary" onclick="saveEditedResponse('\${respId}')">Guardar</button>
            </div>
          </div>
        </div>
      \`;
      document.body.appendChild(modal);
    }
    
    async function saveEditedResponse(respId) {
      const finalText = document.getElementById('edit-response').value;
      const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
      
      analisis.respuestas = analisis.respuestas.map(r => 
        r.id === respId ? { ...r, respuestaFinal: finalText, status: 'revisado' } : r
      );
      
      await DataStore.saveAnalisis(analisis);
      closeModal();
      render();
    }
    
    async function exportAnalysis() {
      const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
      const framework = currentData.frameworks.find(f => f.id === analisis.frameworkId);
      await exportToWord(analisis, framework);
    }
    
    function closeModal() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
    }
    
    // ============================================================
    // INIT
    // ============================================================
    
    async function init() {
      try {
        const [frameworks, analisis] = await Promise.all([
          DataStore.getFrameworks(),
          DataStore.getAnalisis()
        ]);
        
        currentData.frameworks = frameworks;
        currentData.analisis = analisis;
        
        render();
      } catch (error) {
        console.error('Init error:', error);
        document.getElementById('app').innerHTML = \`
          <div class="container" style="text-align: center; padding: 4rem 1rem;">
            <h1 style="color: #ef4444;">Error al cargar</h1>
            <p class="text-gray mt-4">\${error.message}</p>
            <button class="btn btn-primary mt-4" onclick="location.reload()">Reintentar</button>
          </div>
        \`;
      }
    }
    
    // Start app
    document.addEventListener('DOMContentLoaded', init);
    if (document.readyState === 'complete') init();
  </script>
</body>
</html>
