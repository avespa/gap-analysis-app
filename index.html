<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gap Analysis Tool - Professional</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Bibliotecas -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(to bottom, #f9fafb, #fff); min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
    .header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1.5rem 0; margin-bottom: 2rem; position: sticky; top: 0; z-index: 40; }
    .header-content { max-width: 1400px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    h1 { font-size: 2rem; font-weight: 700; color: #111827; }
    h2 { font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 1rem; }
    h3 { font-size: 1.25rem; font-weight: 600; color: #111827; margin-bottom: 0.5rem; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 1rem; display: inline-flex; align-items: center; gap: 0.5rem; font-family: inherit; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #111827; color: white; }
    .btn-primary:hover:not(:disabled) { background: #1f2937; }
    .btn-secondary { background: white; color: #111827; border: 1px solid #d1d5db; }
    .btn-secondary:hover:not(:disabled) { background: #f9fafb; }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .btn-success { background: #059669; color: white; }
    .btn-success:hover:not(:disabled) { background: #047857; }
    .card { background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
    .card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s; }
    .card.clickable { cursor: pointer; }
    .grid { display: grid; gap: 2rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 50; }
    .modal { background: white; border-radius: 0.75rem; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151; }
    input[type="text"], input[type="file"], input[type="range"], select, textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; font-family: inherit; }
    textarea { min-height: 150px; resize: vertical; }
    select[multiple] { min-height: 120px; }
    .hidden { display: none !important; }
    .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
    .badge-gray { background: #f3f4f6; color: #374151; }
    .badge-green { background: #d1fae5; color: #065f46; }
    .badge-yellow { background: #fef3c7; color: #92400e; }
    .badge-red { background: #fee2e2; color: #991b1b; }
    .loader { border: 3px solid #f3f4f6; border-top: 3px solid #111827; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .analysis-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; }
    .gap-item { background: #fee2e2; border: 1px solid #fecaca; border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.5rem; }
    .confidence-bar { height: 8px; background: #e5e7eb; border-radius: 9999px; overflow: hidden; margin-top: 0.5rem; }
    .confidence-fill { height: 100%; transition: width 0.3s; }
    .confidence-high { background: #10b981; }
    .confidence-medium { background: #f59e0b; }
    .confidence-low { background: #ef4444; }
    .temperature-display { text-align: center; font-size: 1.5rem; font-weight: 700; color: #111827; margin: 0.5rem 0; }
    .temperature-label { text-align: center; font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; }
    .doc-selector { background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    .doc-selector label { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; }
    .doc-selector input[type="checkbox"] { width: auto; cursor: pointer; }
    .reference { color: #2563eb; font-weight: 600; background: #dbeafe; padding: 0.125rem 0.375rem; border-radius: 0.25rem; }
    .cost-alert { background: #fef3c7; border: 2px solid #f59e0b; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    .biblio-item { padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    .icon { font-size: 1.5rem; }
    .text-gray { color: #6b7280; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mt-4 { margin-top: 1rem; }
    .flex { display: flex; }
    .gap-2 { gap: 0.5rem; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .processing { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script>
// Configuraci√≥n
const CONFIG = {
  mistralApiKey: 'mAG1EEnyOQjfy5oQ3WPv2wTay0DV9Jhw',
  firebase: {
    apiKey: "AIzaSyDUZR1huz-XHFQBI2CnRGDMxg_f3kFErPA",
    authDomain: "gapanalysis-8b408.firebaseapp.com",
    projectId: "gapanalysis-8b408",
    storageBucket: "gapanalysis-8b408.firebasestorage.app",
    messagingSenderId: "48683423858",
    appId: "1:48683423858:web:7ca2267a11f448b2864aeb"
  },
  costs: {
    inputPer1k: 0.001,
    outputPer1k: 0.003
  }
};

// Estado global
let db = null;
let currentPage = 'home';
let currentData = {
  frameworks: [],
  analisis: [],
  currentAnalisisId: null,
  temperature: 0.3
};

// Configurar PDF.js
if (typeof pdfjsLib !== 'undefined') {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

// Init Firebase
try {
  firebase.initializeApp(CONFIG.firebase);
  db = firebase.firestore();
  console.log('‚úÖ Firestore activo');
} catch (error) {
  console.error('‚ùå Error Firebase:', error);
}

// ============================================================
// EXTRACCI√ìN DE TEXTO
// ============================================================

async function extractTextFromPDF(file) {
  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let fullText = '';
    
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(item => item.str).join(' ');
      fullText += `\n--- P√ÅGINA ${i} ---\n${pageText}`;
    }
    
    return { contenido: fullText, paginas: pdf.numPages };
  } catch (error) {
    console.error('Error extrayendo PDF:', error);
    throw new Error('No se pudo leer el PDF: ' + error.message);
  }
}

async function extractTextFromWord(file) {
  try {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    const text = result.value;
    const estimatedPages = Math.ceil(text.length / 3000);
    return { contenido: text, paginas: estimatedPages };
  } catch (error) {
    console.error('Error extrayendo Word:', error);
    throw new Error('No se pudo leer el Word: ' + error.message);
  }
}

async function processDocument(file, displayId) {
  const ext = file.name.split('.').pop().toLowerCase();
  let extracted;
  
  try {
    if (ext === 'pdf') {
      extracted = await extractTextFromPDF(file);
    } else if (ext === 'docx' || ext === 'doc') {
      extracted = await extractTextFromWord(file);
    } else {
      throw new Error('Formato no soportado. Solo PDF y Word (.docx)');
    }
    
    // Validar que se extrajo contenido
    if (!extracted || !extracted.contenido || extracted.contenido.trim().length < 10) {
      throw new Error(`No se pudo extraer texto del archivo ${file.name}. Puede estar vac√≠o o da√±ado.`);
    }
    
    if (!extracted.paginas || extracted.paginas === 0) {
      throw new Error(`No se pudo determinar el n√∫mero de p√°ginas de ${file.name}`);
    }
    
    return {
      displayId,
      nombre: file.name,
      contenido: extracted.contenido,
      paginas: extracted.paginas,
      tama√±o: file.size,
      uploadedAt: new Date().toISOString()
    };
  } catch (error) {
    console.error('Error procesando documento:', error);
    throw new Error(`Error en ${file.name}: ${error.message}`);
  }
}

// ============================================================
// C√ÅLCULO DE COSTOS
// ============================================================

function estimateTokens(text) {
  return Math.ceil(text.length / 4);
}

function calculateCost(inputTokens, outputTokens) {
  const inputCost = (inputTokens / 1000) * CONFIG.costs.inputPer1k;
  const outputCost = (outputTokens / 1000) * CONFIG.costs.outputPer1k;
  return { inputCost, outputCost, total: inputCost + outputCost };
}

function formatCost(cost) {
  if (cost < 0.01) return '< $0.01';
  return '$' + cost.toFixed(3);
}

// ============================================================
// DATA STORE
// ============================================================

const DataStore = {
  async saveFramework(fw) {
    if (db) {
      const ref = db.collection('frameworks');
      if (fw.id) {
        await ref.doc(fw.id).set(fw);
        return fw;
      }
      const doc = await ref.add(fw);
      return { ...fw, id: doc.id };
    }
    const all = JSON.parse(localStorage.getItem('frameworks') || '[]');
    if (!fw.id) fw.id = Date.now().toString();
    const idx = all.findIndex(f => f.id === fw.id);
    if (idx >= 0) all[idx] = fw;
    else all.push(fw);
    localStorage.setItem('frameworks', JSON.stringify(all));
    return fw;
  },
  
  async getFrameworks() {
    if (db) {
      const snap = await db.collection('frameworks').get();
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    return JSON.parse(localStorage.getItem('frameworks') || '[]');
  },
  
  async deleteFramework(id) {
    if (db) await db.collection('frameworks').doc(id).delete();
    else {
      const all = JSON.parse(localStorage.getItem('frameworks') || '[]');
      localStorage.setItem('frameworks', JSON.stringify(all.filter(f => f.id !== id)));
    }
  },
  
  async saveAnalisis(a) {
    if (db) {
      const ref = db.collection('analisis');
      if (a.id) {
        await ref.doc(a.id).set(a);
        return a;
      }
      const doc = await ref.add(a);
      return { ...a, id: doc.id };
    }
    const all = JSON.parse(localStorage.getItem('analisis') || '[]');
    if (!a.id) a.id = Date.now().toString();
    const idx = all.findIndex(x => x.id === a.id);
    if (idx >= 0) all[idx] = a;
    else all.push(a);
    localStorage.setItem('analisis', JSON.stringify(all));
    return a;
  },
  
  async getAnalisis() {
    if (db) {
      const snap = await db.collection('analisis').get();
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    return JSON.parse(localStorage.getItem('analisis') || '[]');
  }
};


// ============================================================
// UTILIDADES
// ============================================================

function parseExcel(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        
        const categorias = [];
        let currentCat = null;
        let currentElem = null;
        
        rows.slice(1).forEach((row, i) => {
          const catText = row[0]?.toString().trim();
          const elemText = row[1]?.toString().trim();
          const indText = row[2]?.toString().trim();
          
          if (catText) {
            if (currentCat && currentElem) currentCat.elementos.push(currentElem);
            if (currentCat) categorias.push(currentCat);
            currentCat = { id: `cat-${Date.now()}-${i}`, nombre: catText, elementos: [] };
            currentElem = null;
          }
          if (elemText && currentCat) {
            if (currentElem) currentCat.elementos.push(currentElem);
            currentElem = { id: `elem-${Date.now()}-${i}`, nombre: elemText, indicaciones: [] };
          }
          if (indText && currentElem) {
            currentElem.indicaciones.push({ id: `ind-${Date.now()}-${i}`, texto: indText });
          }
        });
        
        if (currentCat && currentElem) currentCat.elementos.push(currentElem);
        if (currentCat) categorias.push(currentCat);
        
        resolve({ nombre: file.name.replace(/\.(xlsx|xls)$/, ''), categorias });
      } catch (error) {
        reject(error);
      }
    };
    reader.onerror = () => reject(reader.error);
    reader.readAsArrayBuffer(file);
  });
}

// ============================================================
// AN√ÅLISIS CON MISTRAL
// ============================================================

async function analyzeWithMistral(indicacion, documentos, selectedDocs, temperature = 0.3) {
  const docsToUse = documentos.filter(d => selectedDocs.includes(d.displayId));
  
  if (docsToUse.length === 0) {
    throw new Error('Debes seleccionar al menos un documento');
  }
  
  // Construir prompt con documentos completos
  let docsText = 'DOCUMENTOS DISPONIBLES:\n\n';
  docsToUse.forEach(doc => {
    docsText += `${doc.displayId}: ${doc.nombre} (${doc.paginas} p√°ginas)\n`;
    docsText += `CONTENIDO:\n${doc.contenido}\n\n`;
  });
  
  const prompt = `Eres un analista especializado en evaluaci√≥n de cumplimiento y control. Tu tarea es analizar documentaci√≥n en diversos √°mbitos: ciberseguridad, gobernanza corporativa, compliance normativo, controles internos, gesti√≥n de riesgos, pol√≠ticas empresariales, y otros marcos de referencia.

CRITERIO A EVALUAR:
${indicacion}

${docsText}

INSTRUCCIONES IMPORTANTES:
1. Analiza OBJETIVAMENTE el contenido real de los documentos
2. Cuando encuentres informaci√≥n relevante, CITA la fuente usando el formato (D1, P5) donde D1 es el documento y P5 es la p√°gina
3. Si no encuentras evidencia clara de cumplimiento, ind√≠calo honestamente
4. Identifica gaps espec√≠ficos y medibles
5. Asigna un nivel de confianza basado en la calidad de la evidencia encontrada:
   - 0.9-1.0: Evidencia clara y completa en los documentos
   - 0.7-0.89: Evidencia presente pero incompleta
   - 0.4-0.69: Evidencia parcial o ambigua
   - 0.0-0.39: Poca o ninguna evidencia

FORMATO DE RESPUESTA (devuelve SOLO JSON v√°lido, sin texto adicional):
{
  "propuestaRespuesta": "An√°lisis profesional del cumplimiento con referencias citadas (D1, P5). M√°ximo 250 palabras.",
  "gapsDetectados": ["Gap espec√≠fico 1", "Gap espec√≠fico 2"],
  "referencias": [{"doc": "D1", "pagina": 5}, {"doc": "D2", "pagina": 12}],
  "confianza": 0.85
}`;

  // Calcular tokens estimados
  const inputTokens = estimateTokens(prompt);
  const estimatedOutputTokens = 500;
  const cost = calculateCost(inputTokens, estimatedOutputTokens);
  
  console.log(`üìä An√°lisis estimado: ${inputTokens} tokens entrada, costo ~${formatCost(cost.total)}`);
  
  try {
    const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${CONFIG.mistralApiKey}`
      },
      body: JSON.stringify({
        model: 'mistral-small-latest',
        temperature: temperature,
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }]
      })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'Error en API de Mistral');
    }
    
    const data = await response.json();
    const content = data.choices?.[0]?.message?.content || '';
    console.log('Respuesta Mistral:', content);
    
    // Extraer JSON
    const jsonMatch = content.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      const parsed = JSON.parse(jsonMatch[0]);
      return {
        propuestaRespuesta: parsed.propuestaRespuesta || 'An√°lisis completado',
        gapsDetectados: Array.isArray(parsed.gapsDetectados) ? parsed.gapsDetectados : [],
        referencias: Array.isArray(parsed.referencias) ? parsed.referencias : [],
        confianza: typeof parsed.confianza === 'number' ? parsed.confianza : 0.5,
        tokensUsados: inputTokens + estimateTokens(content),
        costo: cost.total
      };
    }
    
    return {
      propuestaRespuesta: content || 'Sin respuesta',
      gapsDetectados: [],
      referencias: [],
      confianza: 0.5,
      tokensUsados: inputTokens,
      costo: cost.total
    };
  } catch (error) {
    console.error('Error en Mistral:', error);
    throw error;
  }
}

// ============================================================
// EXPORTAR A WORD
// ============================================================

async function generateRadarChartImage(categoriesData) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    canvas.width = 600;
    canvas.height = 600;
    
    const ctx = canvas.getContext('2d');
    
    const chart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: categoriesData.map(c => c.nombre),
        datasets: [{
          label: 'Nivel de Confianza',
          data: categoriesData.map(c => c.confianza),
          backgroundColor: 'rgba(17, 24, 39, 0.2)',
          borderColor: 'rgb(17, 24, 39)',
          borderWidth: 2,
          pointBackgroundColor: 'rgb(17, 24, 39)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgb(17, 24, 39)'
        }]
      },
      options: {
        responsive: false,
        scales: {
          r: {
            beginAtZero: true,
            max: 100,
            ticks: {
              stepSize: 20
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'An√°lisis de Confianza por Categor√≠a',
            font: {
              size: 18,
              weight: 'bold'
            }
          },
          legend: {
            display: false
          }
        }
      }
    });
    
    setTimeout(() => {
      const imageData = canvas.toDataURL('image/png');
      chart.destroy();
      resolve(imageData);
    }, 500);
  });
}

async function exportToWord(analisis, framework) {
  try {
    if (typeof docx === 'undefined') {
      throw new Error('La librer√≠a docx no est√° cargada. Recarga la p√°gina e intenta de nuevo.');
    }
    
    const { Document, Packer, Paragraph, TextRun, HeadingLevel, Table, TableRow, TableCell, WidthType, AlignmentType, ImageRun, BorderStyle } = docx;
    
    // Calcular estad√≠sticas por categor√≠a
    const categoriesData = framework.categorias.map(cat => {
      const indicacionesCat = cat.elementos.reduce((sum, elem) => sum + elem.indicaciones.length, 0);
      const respuestasCat = (analisis.respuestas || []).filter(r => r.categoriaId === cat.id);
      const confianzaPromedio = respuestasCat.length > 0 
        ? respuestasCat.reduce((sum, r) => sum + (r.confianza || 0), 0) / respuestasCat.length 
        : 0;
      
      return {
        nombre: cat.nombre,
        total: indicacionesCat,
        completadas: respuestasCat.length,
        confianza: Math.round(confianzaPromedio * 100)
      };
    });
    
    // Generar gr√°fico de ara√±a
    const chartImage = await generateRadarChartImage(categoriesData);
    const base64Data = chartImage.split(',')[1];
    
    // Calcular estad√≠sticas globales
    const totalIndicaciones = framework.categorias.reduce((sum, cat) => 
      sum + cat.elementos.reduce((s, elem) => s + elem.indicaciones.length, 0), 0
    );
    const completadas = (analisis.respuestas || []).length;
    const pendientes = totalIndicaciones - completadas;
    const highConf = (analisis.respuestas || []).filter(r => (r.confianza || 0) >= 0.8).length;
    const medConf = (analisis.respuestas || []).filter(r => (r.confianza || 0) >= 0.5 && (r.confianza || 0) < 0.8).length;
    const lowConf = (analisis.respuestas || []).filter(r => (r.confianza || 0) < 0.5).length;
    
    const children = [];
    
    // === PORTADA ===
    children.push(
      new Paragraph({ text: '', spacing: { after: 2000 } }),
      new Paragraph({ text: 'INFORME DE AN√ÅLISIS GAP', heading: HeadingLevel.TITLE, alignment: AlignmentType.CENTER }),
      new Paragraph({ text: '', spacing: { after: 1000 } }),
      new Paragraph({ text: analisis.nombre, heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }),
      new Paragraph({ text: '', spacing: { after: 500 } }),
      new Paragraph({ text: `Framework: ${framework.nombre}`, alignment: AlignmentType.CENTER }),
      new Paragraph({ text: `Fecha: ${new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}`, alignment: AlignmentType.CENTER }),
      new Paragraph({ text: '', spacing: { after: 3000 } })
    );
    
    // === RESUMEN EJECUTIVO ===
    children.push(
      new Paragraph({ text: 'Resumen Ejecutivo', heading: HeadingLevel.HEADING_1, pageBreakBefore: true }),
      new Paragraph({ text: '' }),
      new Paragraph({ 
        children: [
          new TextRun({ text: 'Estado del an√°lisis: ', bold: true }),
          new TextRun(`${completadas} de ${totalIndicaciones} indicaciones completadas (${Math.round(completadas/totalIndicaciones*100)}%)`)
        ]
      }),
      new Paragraph({ 
        children: [
          new TextRun({ text: 'Pendientes: ', bold: true }),
          new TextRun(`${pendientes} indicaciones`)
        ]
      }),
      new Paragraph({ text: '' }),
      new Paragraph({ text: 'Distribuci√≥n de confianza:', bold: true }),
      new Paragraph({ children: [new TextRun({ text: `‚Ä¢ Alta confianza (‚â•80%): `, bold: true }), new TextRun({ text: `${highConf} indicaciones`, color: '059669' })] }),
      new Paragraph({ children: [new TextRun({ text: `‚Ä¢ Media confianza (50-79%): `, bold: true }), new TextRun({ text: `${medConf} indicaciones`, color: 'F59E0B' })] }),
      new Paragraph({ children: [new TextRun({ text: `‚Ä¢ Baja confianza (<50%): `, bold: true }), new TextRun({ text: `${lowConf} indicaciones`, color: 'EF4444' })] }),
      new Paragraph({ text: '' })
    );
    
    // === GR√ÅFICO DE ARA√ëA ===
    children.push(
      new Paragraph({ text: 'An√°lisis Visual por Categor√≠a', heading: HeadingLevel.HEADING_2 }),
      new Paragraph({ text: '' }),
      new Paragraph({
        children: [
          new ImageRun({
            data: base64Data,
            transformation: {
              width: 500,
              height: 500
            }
          })
        ],
        alignment: AlignmentType.CENTER
      }),
      new Paragraph({ text: '' })
    );
    
    // === TABLA DE DATOS PARA GR√ÅFICO EDITABLE ===
    children.push(
      new Paragraph({ text: 'Datos del Gr√°fico (Editable)', heading: HeadingLevel.HEADING_2 }),
      new Paragraph({ 
        text: 'Para crear un gr√°fico editable: Selecciona la tabla ‚Üí Insertar ‚Üí Gr√°fico ‚Üí Radar',
        italics: true,
        color: '6B7280'
      }),
      new Paragraph({ text: '' })
    );
    
    const tableRows = [
      new TableRow({
        children: [
          new TableCell({ 
            children: [new Paragraph({ text: 'Categor√≠a', bold: true, alignment: AlignmentType.CENTER })], 
            shading: { fill: 'F3F4F6' },
            width: { size: 70, type: WidthType.PERCENTAGE }
          }),
          new TableCell({ 
            children: [new Paragraph({ text: 'Confianza (%)', bold: true, alignment: AlignmentType.CENTER })], 
            shading: { fill: 'F3F4F6' },
            width: { size: 30, type: WidthType.PERCENTAGE }
          })
        ]
      }),
      ...categoriesData.map(cat => new TableRow({
        children: [
          new TableCell({ 
            children: [new Paragraph(cat.nombre)],
            width: { size: 70, type: WidthType.PERCENTAGE }
          }),
          new TableCell({ 
            children: [new Paragraph({ text: cat.confianza.toString(), alignment: AlignmentType.CENTER })],
            width: { size: 30, type: WidthType.PERCENTAGE }
          })
        ]
      }))
    ];
    
    children.push(
      new Table({
        rows: tableRows,
        width: { size: 100, type: WidthType.PERCENTAGE },
        borders: {
          top: { style: BorderStyle.SINGLE, size: 1, color: 'D1D5DB' },
          bottom: { style: BorderStyle.SINGLE, size: 1, color: 'D1D5DB' },
          left: { style: BorderStyle.SINGLE, size: 1, color: 'D1D5DB' },
          right: { style: BorderStyle.SINGLE, size: 1, color: 'D1D5DB' },
          insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: 'E5E7EB' },
          insideVertical: { style: BorderStyle.SINGLE, size: 1, color: 'E5E7EB' }
        }
      }),
      new Paragraph({ text: '' })
    );
    
    // === BIBLIOGRAF√çA ===
    children.push(
      new Paragraph({ text: 'Bibliograf√≠a', heading: HeadingLevel.HEADING_1, pageBreakBefore: true })
    );
    
    if ((analisis.documentos || []).length === 0) {
      children.push(new Paragraph({ text: 'No se utilizaron documentos en este an√°lisis', italics: true }));
    } else {
      (analisis.documentos || []).forEach((doc, idx) => {
        children.push(
          new Paragraph({ 
            text: `[${doc.displayId}] ${doc.nombre}`,
            bullet: { level: 0 }
          }),
          new Paragraph({ 
            text: `${doc.paginas || 'N/A'} p√°ginas ‚Ä¢ ${doc.tama√±o ? (doc.tama√±o/1024).toFixed(1) : 'N/A'} KB ‚Ä¢ ${doc.uploadedAt ? new Date(doc.uploadedAt).toLocaleDateString('es-ES') : 'N/A'}`,
            italics: true,
            color: '6B7280'
          })
        );
      });
    }
    
    children.push(new Paragraph({ text: '' }));
    
    // === AN√ÅLISIS DETALLADO ===
    children.push(
      new Paragraph({ text: 'An√°lisis Detallado', heading: HeadingLevel.HEADING_1, pageBreakBefore: true })
    );
    
    framework.categorias.forEach(cat => {
      children.push(
        new Paragraph({ text: '', spacing: { before: 400 } }),
        new Paragraph({ text: cat.nombre, heading: HeadingLevel.HEADING_2 })
      );
      
      cat.elementos.forEach(elem => {
        children.push(
          new Paragraph({ text: elem.nombre, heading: HeadingLevel.HEADING_3 })
        );
        
        elem.indicaciones.forEach(ind => {
          const resp = (analisis.respuestas || []).find(r => r.indicacionId === ind.id);
          
          children.push(
            new Paragraph({ text: '', spacing: { before: 200 } }),
            new Paragraph({ 
              children: [
                new TextRun({ text: 'Indicaci√≥n: ', bold: true }),
                new TextRun(ind.texto)
              ]
            })
          );
          
          if (resp) {
            const confPercent = Math.round((resp.confianza || 0) * 100);
            const confColor = confPercent >= 80 ? '059669' : confPercent >= 50 ? 'F59E0B' : 'EF4444';
            
            children.push(
              new Paragraph({ 
                children: [
                  new TextRun({ text: 'Respuesta: ', bold: true }),
                  new TextRun(resp.respuestaFinal || resp.propuestaIA || 'Sin respuesta')
                ]
              }),
              new Paragraph({ 
                children: [
                  new TextRun({ text: 'Confianza: ', bold: true }),
                  new TextRun({ text: `${confPercent}%`, color: confColor, bold: true })
                ]
              })
            );
            
            if (resp.documentosUsados && resp.documentosUsados.length > 0) {
              children.push(
                new Paragraph({ 
                  children: [
                    new TextRun({ text: 'Documentos consultados: ', bold: true, italics: true }),
                    new TextRun({ text: resp.documentosUsados.join(', '), italics: true })
                  ]
                })
              );
            }
            
            if (resp.gaps && resp.gaps.length > 0) {
              children.push(
                new Paragraph({ 
                  children: [new TextRun({ text: 'Gaps detectados:', bold: true, color: 'DC2626' })] 
                })
              );
              resp.gaps.forEach(gap => {
                children.push(
                  new Paragraph({ 
                    text: gap,
                    bullet: { level: 0 },
                    color: 'DC2626'
                  })
                );
              });
            }
          } else {
            children.push(
              new Paragraph({ 
                children: [
                  new TextRun({ text: 'Estado: ', bold: true }),
                  new TextRun({ text: 'SIN ANALIZAR', color: '6B7280', italics: true })
                ]
              })
            );
          }
        });
      });
    });
    
    // Generar documento
    const doc = new Document({ 
      sections: [{ 
        children,
        properties: {
          page: {
            margin: {
              top: 1440,
              right: 1440,
              bottom: 1440,
              left: 1440
            }
          }
        }
      }] 
    });
    
    const blob = await Packer.toBlob(doc);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Informe_${analisis.nombre.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.docx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert('‚úÖ Informe descargado exitosamente');
  } catch (error) {
    console.error('Error exportando:', error);
    alert('‚ùå Error al exportar: ' + error.message);
  }
}


// ============================================================
// RENDERIZADO
// ============================================================

function render() {
  const app = document.getElementById('app');
  
  if (currentPage === 'home') {
    app.innerHTML = renderHome();
  } else if (currentPage === 'frameworks') {
    app.innerHTML = renderFrameworks();
  } else if (currentPage === 'analysis') {
    app.innerHTML = renderAnalysisList();
  } else if (currentPage === 'analysis-detail') {
    renderAnalysisDetail();
  }
}

function renderHome() {
  return `
    <div class="header">
      <div class="header-content">
        <h1>üéØ Gap Analysis Tool Professional</h1>
      </div>
    </div>
    <div class="container">
      <div class="grid">
        <div class="card clickable" onclick="navigateTo('frameworks')">
          <div class="icon mb-4">üìÅ</div>
          <h2>Frameworks</h2>
          <p class="text-gray">Gestiona plantillas de an√°lisis desde Excel</p>
          <p class="text-sm text-gray mt-4">${currentData.frameworks.length} frameworks disponibles</p>
        </div>
        <div class="card clickable" onclick="navigateTo('analysis')">
          <div class="icon mb-4">üìÑ</div>
          <h2>An√°lisis</h2>
          <p class="text-gray">Crea an√°lisis con IA y trazabilidad completa</p>
          <p class="text-sm text-gray mt-4">${currentData.analisis.length} an√°lisis creados</p>
        </div>
      </div>
    </div>
  `;
}

function renderFrameworks() {
  const frameworks = currentData.frameworks;
  return `
    <div class="header">
      <div class="header-content">
        <div class="flex items-center gap-2">
          <button class="btn btn-secondary btn-sm" onclick="navigateTo('home')">‚¨ÖÔ∏è Inicio</button>
          <h1>Frameworks</h1>
        </div>
        <button class="btn btn-primary" onclick="showNewFrameworkModal()">‚ûï Nuevo Framework</button>
      </div>
    </div>
    <div class="container">
      ${frameworks.length === 0 ? `
        <div class="card" style="text-align:center;">
          <h3>No hay frameworks</h3>
          <p class="text-gray mb-4">Crea tu primer framework desde un archivo Excel</p>
          <button class="btn btn-primary" onclick="showNewFrameworkModal()">Crear Framework</button>
        </div>
      ` : `
        <div class="grid">
          ${frameworks.map(fw => `
            <div class="card">
              <h3>${fw.nombre}</h3>
              <p class="text-gray text-sm mb-4">${fw.categorias.length} categor√≠as ‚Ä¢ ${fw.categorias.reduce((sum, c) => sum + c.elementos.length, 0)} elementos</p>
              <button class="btn btn-secondary btn-sm" onclick="deleteFramework('${fw.id}')">üóëÔ∏è Eliminar</button>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;
}

function renderAnalysisList() {
  const analisisList = currentData.analisis;
  const frameworks = currentData.frameworks;
  
  return `
    <div class="header">
      <div class="header-content">
        <div class="flex items-center gap-2">
          <button class="btn btn-secondary btn-sm" onclick="navigateTo('home')">‚¨ÖÔ∏è Inicio</button>
          <h1>An√°lisis</h1>
        </div>
        <button class="btn btn-primary" onclick="showNewAnalysisModal()" ${frameworks.length === 0 ? 'disabled' : ''}>‚ûï Nuevo An√°lisis</button>
      </div>
    </div>
    <div class="container">
      ${frameworks.length === 0 ? `
        <div class="card" style="text-align:center;">
          <h3>No hay frameworks disponibles</h3>
          <p class="text-gray mb-4">Primero debes crear un framework</p>
          <button class="btn btn-primary" onclick="navigateTo('frameworks')">Ir a Frameworks</button>
        </div>
      ` : analisisList.length === 0 ? `
        <div class="card" style="text-align:center;">
          <h3>No hay an√°lisis</h3>
          <p class="text-gray mb-4">Crea tu primer an√°lisis</p>
          <button class="btn btn-primary" onclick="showNewAnalysisModal()">Crear An√°lisis</button>
        </div>
      ` : `
        <div class="grid">
          ${analisisList.map(a => `
            <div class="card">
              <div onclick="viewAnalysis('${a.id}')" style="cursor:pointer;">
                <h3>${a.nombre}</h3>
                <p class="text-gray text-sm">${a.frameworkNombre}</p>
                <p class="text-gray text-sm mt-4">
                  üìö ${(a.documentos || []).length} documentos
                  ${a.temperature !== undefined ? `‚Ä¢ üå°Ô∏è ${a.temperature}` : ''}
                </p>
              </div>
              <button class="btn btn-secondary btn-sm mt-4" onclick="event.stopPropagation(); deleteAnalisis('${a.id}')">üóëÔ∏è Eliminar</button>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;
}

function getConfidenceColor(conf) {
  if (conf >= 0.8) return 'green';
  if (conf >= 0.5) return 'yellow';
  return 'red';
}

function getConfidenceLabel(conf) {
  if (conf >= 0.8) return 'Alta';
  if (conf >= 0.5) return 'Media';
  return 'Baja';
}

function renderAnalysisDetail() {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const framework = currentData.frameworks.find(f => f.id === analisis?.frameworkId);
  
  if (!analisis || !framework) {
    document.getElementById('app').innerHTML = '<div class="container"><div class="loader"></div></div>';
    return;
  }
  
  const temperature = analisis.temperature !== undefined ? analisis.temperature : 0.3;
  
  let html = `
    <div class="header">
      <div class="header-content">
        <div>
          <div style="font-size:0.875rem;color:#6b7280;margin-bottom:0.5rem;">
            <a href="#" onclick="navigateTo('home');return false;" style="color:#2563eb;text-decoration:none;">Inicio</a>
            <span> / </span>
            <a href="#" onclick="navigateTo('analysis');return false;" style="color:#2563eb;text-decoration:none;">An√°lisis</a>
            <span> / </span>
            <span style="color:#111827;font-weight:500;">${analisis.nombre}</span>
          </div>
          <h1>${analisis.nombre}</h1>
          <p class="text-gray text-sm">${framework.nombre}</p>
        </div>
        <div class="flex gap-2" style="flex-wrap:wrap;">
          <button class="btn btn-primary btn-sm" onclick="showBatchAnalysisModal()">üöÄ Analizar TODAS las pendientes</button>
          <button class="btn btn-secondary btn-sm" onclick="showBibliografia()">üìö Bibliograf√≠a</button>
          <button class="btn btn-secondary btn-sm" onclick="showStats()">üìä Estad√≠sticas</button>
          <button class="btn btn-success btn-sm" onclick="exportAnalysis()">‚¨áÔ∏è Exportar Word</button>
        </div>
      </div>
    </div>
    
    <div class="container">
      <!-- Configuraci√≥n de temperatura -->
      <div class="card">
        <h3>‚öôÔ∏è Configuraci√≥n de An√°lisis</h3>
        <div class="form-group">
          <label>Temperatura de IA: <span class="temperature-display">${temperature.toFixed(1)}</span></label>
          <input type="range" min="0" max="1" step="0.1" value="${temperature}" 
                 onchange="updateTemperature(this.value)" 
                 oninput="this.previousElementSibling.querySelector('.temperature-display').textContent = parseFloat(this.value).toFixed(1)">
          <div class="temperature-label">
            <strong>0.0</strong> = Consistente y preciso (mismo resultado siempre) | 
            <strong>1.0</strong> = Creativo y variado (diferentes resultados)<br>
            <strong>Recomendado: 0.3</strong> para an√°lisis profesional
          </div>
        </div>
      </div>
      
      <!-- Filtros y b√∫squeda -->
      <div class="card">
        <div class="flex justify-between items-center mb-4" style="flex-wrap:wrap;gap:1rem;">
          <h3 style="margin:0;">üîç Filtros y B√∫squeda</h3>
          <button class="btn btn-secondary btn-sm" onclick="clearFilters()">üîÑ Limpiar filtros</button>
        </div>
        
        <div style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));">
          <div class="form-group" style="margin:0;">
            <label>Buscar en indicaciones:</label>
            <input type="text" id="search-text" placeholder="Escribe para buscar..." 
                   oninput="applyFilters()" style="margin:0;">
          </div>
          
          <div class="form-group" style="margin:0;">
            <label>Filtrar por estado:</label>
            <select id="filter-status" onchange="applyFilters()" style="margin:0;">
              <option value="all">Todas</option>
              <option value="pending">Solo pendientes</option>
              <option value="completed">Solo completadas</option>
              <option value="reviewed">Solo revisadas</option>
            </select>
          </div>
          
          <div class="form-group" style="margin:0;">
            <label>Filtrar por confianza:</label>
            <select id="filter-confidence" onchange="applyFilters()" style="margin:0;">
              <option value="all">Todas</option>
              <option value="high">Alta (‚â•80%)</option>
              <option value="medium">Media (50-79%)</option>
              <option value="low">Baja (<50%)</option>
            </select>
          </div>
        </div>
        
        <div id="filter-results" class="mt-4 text-sm text-gray" style="display:none;">
          <!-- Se mostrar√° aqu√≠ el resultado del filtro -->
        </div>
      </div>
      
      <!-- Documentos -->
      <div class="card">
        <div class="flex justify-between items-center mb-4">
          <h3>üìö Documentos (${(analisis.documentos || []).length})</h3>
          <label class="btn btn-primary btn-sm" style="cursor:pointer;">
            <input type="file" accept=".pdf,.docx,.doc" multiple onchange="handleUploadDocs(event)" style="display:none;">
            ‚ûï Subir Documentos
          </label>
        </div>
        ${(analisis.documentos || []).length === 0 ? `
          <p class="text-gray text-sm">No hay documentos. Sube PDFs o Word para analizar.</p>
        ` : `
          <div style="display:grid; gap:0.5rem;">
            ${(analisis.documentos || []).map(doc => `
              <div class="biblio-item">
                <div class="flex justify-between items-center">
                  <div>
                    <strong>${doc.displayId}:</strong> ${doc.nombre}
                    <span class="text-gray text-sm">‚Ä¢ ${doc.paginas} p√°ginas ‚Ä¢ ${(doc.tama√±o / 1024).toFixed(0)} KB</span>
                  </div>
                  <div class="flex gap-2">
                    <button class="btn btn-secondary btn-sm" onclick="viewDocContent('${doc.displayId}')">üëÅÔ∏è Ver</button>
                    <button class="btn btn-secondary btn-sm" onclick="deleteDocument('${doc.displayId}')">üóëÔ∏è</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>
  `;
  
  // Indicaciones por categor√≠a
  framework.categorias.forEach(cat => {
    // Calcular progreso de la categor√≠a
    const totalIndicacionesCat = cat.elementos.reduce((sum, elem) => sum + elem.indicaciones.length, 0);
    const completadasCat = (analisis.respuestas || []).filter(r => r.categoriaId === cat.id).length;
    const progressPercent = totalIndicacionesCat > 0 ? Math.round((completadasCat / totalIndicacionesCat) * 100) : 0;
    const progressColor = progressPercent === 100 ? '#10b981' : progressPercent >= 50 ? '#f59e0b' : '#6b7280';
    
    html += `<div class="card">
      <div class="flex justify-between items-center mb-4">
        <h2 style="margin:0;">${cat.nombre}</h2>
        <div style="text-align:right;">
          <div class="text-sm text-gray">${completadasCat} / ${totalIndicacionesCat} completadas</div>
          <div style="width:200px;background:#e5e7eb;height:8px;border-radius:4px;overflow:hidden;margin-top:0.25rem;">
            <div style="background:${progressColor};height:100%;width:${progressPercent}%;transition:width 0.3s;"></div>
          </div>
        </div>
      </div>`;
    
    cat.elementos.forEach(elem => {
      html += `<div style="margin-top:1.5rem;padding-left:1rem;border-left:2px solid #e5e7eb;"><h3>${elem.nombre}</h3>`;
      
      elem.indicaciones.forEach(ind => {
        const resp = (analisis.respuestas || []).find(r => r.indicacionId === ind.id);
        const allDocs = (analisis.documentos || []).map(d => d.displayId);
        const selectedDocs = resp?.documentosUsados || allDocs;
        
        html += `
          <div class="analysis-item" 
               data-search-text="${ind.texto.toLowerCase()}" 
               data-status="${resp ? (resp.respuestaFinal ? 'reviewed' : 'completed') : 'pending'}"
               data-confidence="${resp ? Math.round((resp.confianza || 0) * 100) : '0'}">
            <div class="flex justify-between items-start gap-2 mb-4">
              <p class="text-sm flex-1"><strong>Indicaci√≥n:</strong> ${ind.texto}</p>
              <div class="flex gap-2" style="flex-wrap:wrap;">
                <button class="btn btn-primary btn-sm" data-cat="${cat.id}" data-elem="${elem.id}" data-ind="${ind.id}" data-texto="${ind.texto.replace(/"/g, '&quot;')}" onclick="showAnalyzeModal(this.dataset.cat, this.dataset.elem, this.dataset.ind, this.dataset.texto)">
                  ü§ñ Analizar con IA
                </button>
                ${resp ? `
                  ${!resp.respuestaFinal ? `<button class="btn btn-success btn-sm" onclick="approveAIResponse('${resp.id}')">‚úÖ Aprobar IA</button>` : ''}
                  <button class="btn btn-secondary btn-sm" onclick="editResponse('${resp.id}')">‚úèÔ∏è Editar</button>
                ` : ''}
              </div>
            </div>
        `;
        
        if (resp) {
          const confColor = getConfidenceColor(resp.confianza || 0);
          const confLabel = getConfidenceLabel(resp.confianza || 0);
          const confPercent = Math.round((resp.confianza || 0) * 100);
          
          html += `
            <div style="background:white;padding:1rem;border-radius:0.5rem;border:1px solid #e5e7eb;">
              <p class="text-sm text-gray mb-2">${resp.respuestaFinal ? 'Respuesta Final:' : 'Propuesta IA:'}</p>
              <p class="text-sm">${resp.respuestaFinal || resp.propuestaIA || 'Sin respuesta'}</p>
              
              <div class="mt-4">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm"><strong>Confianza:</strong> <span class="badge badge-${confColor}">${confPercent}% (${confLabel})</span></span>
                  ${resp.costo ? `<span class="text-xs text-gray">Costo: ${formatCost(resp.costo)}</span>` : ''}
                </div>
                <div class="confidence-bar">
                  <div class="confidence-fill confidence-${confColor}" style="width:${confPercent}%"></div>
                </div>
              </div>
              
              ${resp.documentosUsados && resp.documentosUsados.length > 0 ? `
                <p class="text-xs text-gray mt-2">üìÑ Documentos usados: ${resp.documentosUsados.join(', ')}</p>
              ` : ''}
              
              ${resp.notas ? `
                <div style="margin-top:1rem;padding:0.75rem;background:#fef3c7;border:1px solid #fbbf24;border-radius:0.5rem;">
                  <p class="text-sm" style="font-weight:600;color:#92400e;margin-bottom:0.25rem;">üìù Notas internas:</p>
                  <p class="text-sm" style="color:#92400e;">${resp.notas}</p>
                  <button class="btn btn-secondary btn-sm mt-2" onclick="editNotes('${resp.id}')" style="padding:0.25rem 0.5rem;font-size:0.75rem;">‚úèÔ∏è Editar nota</button>
                </div>
              ` : `
                <button class="btn btn-secondary btn-sm mt-3" onclick="addNote('${resp.id}')" style="padding:0.25rem 0.5rem;font-size:0.75rem;">üìù Agregar nota interna</button>
              `}
            </div>
          `;
          
          if (resp.gaps && resp.gaps.length > 0) {
            html += `
              <div class="gap-item mt-4">
                <p class="text-sm" style="font-weight:600;color:#991b1b;margin-bottom:0.5rem;">‚ö†Ô∏è Gaps detectados:</p>
                ${resp.gaps.map(gap => `<p class="text-sm" style="color:#991b1b;">‚Ä¢ ${gap}</p>`).join('')}
              </div>
            `;
          }
        } else {
          html += '<p class="text-sm text-gray" style="font-style:italic;">‚è≥ Pendiente de an√°lisis</p>';
        }
        
        html += '</div>';
      });
      
      html += '</div>';
    });
    
    html += '</div>';
  });
  
  html += '</div>';
  document.getElementById('app').innerHTML = html;
}


// ============================================================
// EVENT HANDLERS
// ============================================================

function navigateTo(page) {
  currentPage = page;
  render();
}

function showNewFrameworkModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>Nuevo Framework</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Nombre del Framework</label>
          <input type="text" id="fw-nombre" placeholder="Ej: ISO 27001">
        </div>
        <div class="form-group">
          <label>Archivo Excel (.xlsx, .xls)</label>
          <input type="file" id="fw-file" accept=".xlsx,.xls">
          <p class="text-xs text-gray mt-2">Formato: Columna 1=Categor√≠a, 2=Elemento, 3=Indicaci√≥n</p>
        </div>
        <button class="btn btn-primary" onclick="createFramework()">Crear Framework</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function createFramework() {
  const nombre = document.getElementById('fw-nombre').value;
  const file = document.getElementById('fw-file').files[0];
  
  if (!file) return alert('‚ùå Selecciona un archivo Excel');
  
  try {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '‚è≥ Procesando...';
    
    const parsed = await parseExcel(file);
    const fw = {
      ...parsed,
      nombre: nombre || parsed.nombre,
      createdAt: new Date(),
      updatedAt: new Date()
    };
    
    const saved = await DataStore.saveFramework(fw);
    currentData.frameworks.push(saved);
    closeModal();
    navigateTo('frameworks');
  } catch (error) {
    alert('‚ùå Error al cargar Excel: ' + error.message);
    event.target.disabled = false;
    event.target.textContent = 'Crear Framework';
  }
}

async function deleteFramework(id) {
  if (!confirm('¬øEliminar este framework?')) return;
  await DataStore.deleteFramework(id);
  currentData.frameworks = currentData.frameworks.filter(f => f.id !== id);
  render();
}

function showNewAnalysisModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>Nuevo An√°lisis</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Nombre del An√°lisis</label>
          <input type="text" id="an-nombre" placeholder="Ej: Auditor√≠a Q1 2024">
        </div>
        <div class="form-group">
          <label>Framework a utilizar</label>
          <select id="an-framework">
            <option value="">Selecciona un framework...</option>
            ${currentData.frameworks.map(fw => `<option value="${fw.id}">${fw.nombre}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Temperatura de IA (Recomendado: 0.3)</label>
          <input type="range" id="an-temp" min="0" max="1" step="0.1" value="0.3" 
                 oninput="document.getElementById('temp-display').textContent = this.value">
          <p class="text-sm text-gray">Temperatura seleccionada: <strong id="temp-display">0.3</strong></p>
        </div>
        <button class="btn btn-primary" onclick="createAnalysis()">Crear An√°lisis</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function createAnalysis() {
  const nombre = document.getElementById('an-nombre').value;
  const fwId = document.getElementById('an-framework').value;
  const temperature = parseFloat(document.getElementById('an-temp').value);
  
  if (!nombre || !fwId) return alert('‚ùå Completa todos los campos');
  
  const fw = currentData.frameworks.find(f => f.id === fwId);
  const newAnalisis = {
    nombre,
    frameworkId: fwId,
    frameworkNombre: fw.nombre,
    documentos: [],
    respuestas: [],
    temperature,
    status: 'borrador',
    createdAt: new Date()
  };
  
  const saved = await DataStore.saveAnalisis(newAnalisis);
  currentData.analisis.push(saved);
  currentData.currentAnalisisId = saved.id;
  closeModal();
  navigateTo('analysis-detail');
}

function viewAnalysis(id) {
  currentData.currentAnalisisId = id;
  navigateTo('analysis-detail');
}

async function handleUploadDocs(event) {
  const files = Array.from(event.target.files);
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  
  if (files.length === 0) return;
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>Procesando Documentos</h2>
      </div>
      <div class="modal-body">
        <div class="loader"></div>
        <p class="text-center text-gray mt-4">Extrayendo texto de ${files.length} documento(s)...</p>
        <p class="text-center text-sm text-gray" id="progress">0 / ${files.length}</p>
        <div id="errors" class="mt-4" style="max-height:200px;overflow-y:auto;"></div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  try {
    const nextId = (analisis.documentos || []).length + 1;
    const processed = [];
    const errors = [];
    
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      document.getElementById('progress').textContent = `${i + 1} / ${files.length} - ${file.name}`;
      
      try {
        const displayId = `D${nextId + processed.length}`;
        const doc = await processDocument(file, displayId);
        processed.push(doc);
        
        // Mostrar √©xito
        const errorDiv = document.getElementById('errors');
        errorDiv.innerHTML += `<p class="text-sm" style="color:#059669;">‚úÖ ${file.name}</p>`;
      } catch (error) {
        errors.push({ file: file.name, error: error.message });
        
        // Mostrar error
        const errorDiv = document.getElementById('errors');
        errorDiv.innerHTML += `<p class="text-sm" style="color:#dc2626;">‚ùå ${file.name}: ${error.message}</p>`;
      }
    }
    
    if (processed.length > 0) {
      analisis.documentos = [...(analisis.documentos || []), ...processed];
      await DataStore.saveAnalisis(analisis);
    }
    
    setTimeout(() => {
      closeModal();
      
      if (processed.length > 0 && errors.length === 0) {
        alert(`‚úÖ ${processed.length} documento(s) procesado(s) exitosamente`);
      } else if (processed.length > 0 && errors.length > 0) {
        alert(`‚ö†Ô∏è Procesados: ${processed.length} exitosos, ${errors.length} fallidos.\n\nVerifica que los PDFs no est√©n da√±ados o protegidos.`);
      } else {
        alert(`‚ùå No se pudo procesar ning√∫n documento.\n\nAseg√∫rate de que los archivos no est√©n da√±ados o protegidos con contrase√±a.`);
      }
      
      render();
    }, 2000);
  } catch (error) {
    closeModal();
    alert('‚ùå Error procesando documentos: ' + error.message);
  }
}

function updateTemperature(value) {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  analisis.temperature = parseFloat(value);
  DataStore.saveAnalisis(analisis);
}

function showAnalyzeModal(catId, elemId, indId, indTexto) {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  
  if (!analisis.documentos || analisis.documentos.length === 0) {
    return alert('‚ö†Ô∏è Primero debes subir documentos para poder analizar');
  }
  
  const allDocs = analisis.documentos.map(d => d.displayId);
  const resp = (analisis.respuestas || []).find(r => r.indicacionId === indId);
  
  // Verificar si ya est√° revisado
  if (resp && resp.status === 'revisado') {
    if (!confirm('‚ö†Ô∏è ATENCI√ìN\n\nEsta indicaci√≥n ya fue revisada manualmente.\n\n¬øDeseas re-analizar con IA? Esto sobrescribir√° la propuesta de IA anterior (tu respuesta final se mantendr√°).')) {
      return;
    }
  }
  
  const prevSelected = resp?.documentosUsados || allDocs;
  
  // Calcular costo estimado
  let totalTokens = 0;
  analisis.documentos.forEach(doc => {
    totalTokens += estimateTokens(doc.contenido);
  });
  totalTokens += estimateTokens(indTexto) + 500; // prompt + respuesta estimada
  const estimatedCost = calculateCost(totalTokens, 500);
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>Analizar con IA</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label><strong>Indicaci√≥n:</strong></label>
          <p class="text-sm">${indTexto}</p>
        </div>
        
        <div class="cost-alert">
          <p><strong>üí∞ Estimaci√≥n de costos:</strong></p>
          <p class="text-sm">‚Ä¢ Tokens estimados: ~${totalTokens.toLocaleString()}</p>
          <p class="text-sm">‚Ä¢ Costo aproximado: ${formatCost(estimatedCost.total)}</p>
          <p class="text-xs text-gray mt-2">El costo real puede variar seg√∫n la longitud de la respuesta</p>
        </div>
        
        <div class="doc-selector">
          <label style="display:block;margin-bottom:1rem;"><strong>üìë Selecciona documentos para analizar:</strong></label>
          <p class="text-xs text-gray mb-3">Solo se enviar√°n los documentos seleccionados a la IA</p>
          <div style="display:grid;gap:0.75rem;">
            ${analisis.documentos.map(doc => `
              <label style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:white;border:1px solid #e5e7eb;border-radius:0.5rem;cursor:pointer;">
                <input type="checkbox" class="doc-checkbox" value="${doc.displayId}" 
                       ${prevSelected.includes(doc.displayId) ? 'checked' : ''}
                       style="width:20px;height:20px;">
                <div style="flex:1;">
                  <div><strong>${doc.displayId}:</strong> ${doc.nombre}</div>
                  <div class="text-xs text-gray">${doc.paginas} p√°ginas ‚Ä¢ ${(doc.tama√±o/1024).toFixed(0)} KB</div>
                </div>
              </label>
            `).join('')}
          </div>
        </div>
        
        <div class="flex gap-2">
          <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
          <button class="btn btn-success" onclick="analyzeIndicacion('${catId}','${elemId}','${indId}','${indTexto.replace(/'/g, "\\'")}')">
            üöÄ Analizar (${formatCost(estimatedCost.total)})
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function analyzeIndicacion(catId, elemId, indId, indTexto) {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const selectedDocs = Array.from(document.querySelectorAll('.doc-checkbox:checked')).map(cb => cb.value);
  
  if (selectedDocs.length === 0) {
    return alert('‚ö†Ô∏è Debes seleccionar al menos un documento');
  }
  
  const modal = document.querySelector('.modal-overlay');
  modal.querySelector('.modal-body').innerHTML = `
    <div class="loader"></div>
    <p class="text-center text-gray mt-4">Analizando con IA...</p>
    <p class="text-center text-sm text-gray">Esto puede tomar 10-30 segundos</p>
  `;
  
  try {
    const result = await analyzeWithMistral(
      indTexto,
      analisis.documentos,
      selectedDocs,
      analisis.temperature
    );
    
    const newResp = {
      id: `resp-${Date.now()}`,
      categoriaId: catId,
      elementoId: elemId,
      indicacionId: indId,
      propuestaIA: result.propuestaRespuesta,
      respuestaFinal: '',
      gaps: result.gapsDetectados,
      referencias: result.referencias,
      confianza: result.confianza,
      documentosUsados: selectedDocs,
      tokensUsados: result.tokensUsados,
      costo: result.costo,
      status: 'completado',
      analyzedAt: new Date()
    };
    
    if (!analisis.respuestas) analisis.respuestas = [];
    const idx = analisis.respuestas.findIndex(r => r.indicacionId === indId);
    if (idx >= 0) analisis.respuestas[idx] = newResp;
    else analisis.respuestas.push(newResp);
    
    await DataStore.saveAnalisis(analisis);
    closeModal();
    render();
  } catch (error) {
    closeModal();
    alert('‚ùå Error al analizar: ' + error.message);
  }
}

function editResponse(respId) {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const resp = analisis.respuestas.find(r => r.id === respId);
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>Editar Respuesta</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body">
        ${resp.versiones && resp.versiones.length > 0 ? `
          <div style="margin-bottom:1rem;">
            <button class="btn btn-secondary btn-sm" onclick="showVersionHistory('${respId}')">
              üìú Ver historial (${resp.versiones.length} versiones anteriores)
            </button>
          </div>
        ` : ''}
        
        <div class="form-group">
          <label>Propuesta de la IA:</label>
          <div style="padding:1rem;background:#f9fafb;border-radius:0.5rem;max-height:200px;overflow-y:auto;">
            <p class="text-sm">${resp.propuestaIA}</p>
          </div>
        </div>
        
        ${resp.referencias && resp.referencias.length > 0 ? `
          <div class="form-group">
            <label>Referencias encontradas:</label>
            <p class="text-sm">
              ${resp.referencias.map(ref => `<span class="reference">${ref.doc}, P${ref.pagina}</span>`).join(' ')}
            </p>
          </div>
        ` : ''}
        
        <div class="form-group">
          <label>Respuesta Final:</label>
          <textarea id="edit-response">${resp.respuestaFinal || resp.propuestaIA}</textarea>
          <p class="text-xs text-gray">Puedes editar y agregar referencias manualmente (D1, P5)</p>
        </div>
        
        <div class="flex gap-2">
          <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
          <button class="btn btn-success" onclick="saveEditedResponse('${respId}')">‚úÖ Guardar</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function saveEditedResponse(respId) {
  const finalText = document.getElementById('edit-response').value;
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const resp = analisis.respuestas.find(r => r.id === respId);
  
  // Guardar versi√≥n anterior en historial
  if (!resp.versiones) resp.versiones = [];
  
  if (resp.respuestaFinal || resp.propuestaIA) {
    resp.versiones.push({
      fecha: new Date().toISOString(),
      texto: resp.respuestaFinal || resp.propuestaIA,
      tipo: resp.respuestaFinal ? 'usuario' : 'ia',
      autor: resp.respuestaFinal ? 'Usuario' : 'IA'
    });
  }
  
  // Actualizar respuesta
  analisis.respuestas = analisis.respuestas.map(r => 
    r.id === respId ? { ...r, respuestaFinal: finalText, status: 'revisado', editadoEn: new Date().toISOString() } : r
  );
  
  await DataStore.saveAnalisis(analisis);
  closeModal();
  render();
}

function addNote(respId) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>üìù Agregar Nota Interna</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Nota (no se exportar√° al Word):</label>
          <textarea id="note-text" placeholder="Ej: Pendiente de revisar con equipo legal..."></textarea>
          <p class="text-xs text-gray mt-2">
            Las notas son para uso interno. √ötil para recordatorios, dudas pendientes o TODOs.
          </p>
        </div>
        
        <div class="flex gap-2">
          <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
          <button class="btn btn-primary" onclick="saveNote('${respId}')">üíæ Guardar Nota</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function editNotes(respId) {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const resp = analisis.respuestas.find(r => r.id === respId);
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>‚úèÔ∏è Editar Nota Interna</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Nota:</label>
          <textarea id="note-text">${resp.notas || ''}</textarea>
        </div>
        
        <div class="flex gap-2">
          <button class="btn btn-secondary" onclick="deleteNote('${respId}')">üóëÔ∏è Eliminar nota</button>
          <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
          <button class="btn btn-primary" onclick="saveNote('${respId}')">üíæ Guardar</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function saveNote(respId) {
  const noteText = document.getElementById('note-text').value.trim();
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  
  analisis.respuestas = analisis.respuestas.map(r => 
    r.id === respId ? { ...r, notas: noteText } : r
  );
  
  await DataStore.saveAnalisis(analisis);
  closeModal();
  render();
}

async function deleteNote(respId) {
  if (!confirm('¬øEliminar la nota?')) return;
  
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  
  analisis.respuestas = analisis.respuestas.map(r => 
    r.id === respId ? { ...r, notas: '' } : r
  );
  
  await DataStore.saveAnalisis(analisis);
  closeModal();
  render();
}

function showVersionHistory(respId) {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const resp = analisis.respuestas.find(r => r.id === respId);
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>üìú Historial de Versiones</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
        <div style="margin-bottom:1.5rem;padding:1rem;background:#d1fae5;border:1px solid #10b981;border-radius:0.5rem;">
          <div class="flex justify-between items-center mb-2">
            <strong style="color:#065f46;">‚úì Versi√≥n Actual</strong>
            <span class="text-xs" style="color:#065f46;">
              ${resp.editadoEn ? new Date(resp.editadoEn).toLocaleString('es-ES') : 'Ahora'}
            </span>
          </div>
          <p class="text-sm" style="color:#065f46;margin-bottom:0.5rem;">
            ${resp.respuestaFinal || resp.propuestaIA}
          </p>
          <span class="badge badge-green">${resp.status === 'revisado' ? 'Usuario (editado)' : 'IA'}</span>
        </div>
        
        ${(resp.versiones || []).reverse().map((ver, idx) => `
          <div style="margin-bottom:1rem;padding:1rem;background:#f9fafb;border:1px solid #e5e7eb;border-radius:0.5rem;">
            <div class="flex justify-between items-center mb-2">
              <strong class="text-sm">Versi√≥n ${resp.versiones.length - idx}</strong>
              <span class="text-xs text-gray">${new Date(ver.fecha).toLocaleString('es-ES')}</span>
            </div>
            <p class="text-sm text-gray mb-2">${ver.texto}</p>
            <div class="flex gap-2 items-center">
              <span class="badge badge-gray">${ver.autor}</span>
              <button class="btn btn-secondary btn-sm" onclick="restoreVersion('${respId}', ${resp.versiones.length - idx - 1})" style="padding:0.25rem 0.5rem;font-size:0.75rem;">
                ‚Ü©Ô∏è Restaurar esta versi√≥n
              </button>
            </div>
          </div>
        `).join('')}
        
        ${!resp.versiones || resp.versiones.length === 0 ? `
          <p class="text-gray text-center">No hay versiones anteriores</p>
        ` : ''}
        
        <button class="btn btn-secondary mt-4" onclick="closeModal();editResponse('${respId}')">‚¨ÖÔ∏è Volver a editar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function restoreVersion(respId, versionIndex) {
  if (!confirm('¬øRestaurar esta versi√≥n?\n\nLa versi√≥n actual se guardar√° en el historial.')) return;
  
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const resp = analisis.respuestas.find(r => r.id === respId);
  
  const versionToRestore = resp.versiones[versionIndex];
  
  // Guardar versi√≥n actual en historial
  resp.versiones.push({
    fecha: new Date().toISOString(),
    texto: resp.respuestaFinal || resp.propuestaIA,
    tipo: resp.respuestaFinal ? 'usuario' : 'ia',
    autor: resp.respuestaFinal ? 'Usuario' : 'IA'
  });
  
  // Restaurar versi√≥n
  analisis.respuestas = analisis.respuestas.map(r => 
    r.id === respId ? { 
      ...r, 
      respuestaFinal: versionToRestore.texto, 
      status: 'revisado',
      editadoEn: new Date().toISOString()
    } : r
  );
  
  await DataStore.saveAnalisis(analisis);
  closeModal();
  render();
}

async function approveAIResponse(respId) {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const resp = analisis.respuestas.find(r => r.id === respId);
  
  if (!confirm('¬øAprobar la propuesta de IA como respuesta final?\n\nPodr√°s editarla despu√©s si es necesario.')) return;
  
  analisis.respuestas = analisis.respuestas.map(r => 
    r.id === respId ? { ...r, respuestaFinal: r.propuestaIA, status: 'revisado' } : r
  );
  
  await DataStore.saveAnalisis(analisis);
  render();
}

async function deleteDocument(displayId) {
  if (!confirm(`¬øEliminar ${displayId}?\n\n‚ö†Ô∏è Las referencias a este documento quedar√°n rotas.`)) return;
  
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  analisis.documentos = analisis.documentos.filter(d => d.displayId !== displayId);
  
  await DataStore.saveAnalisis(analisis);
  alert(`‚úÖ ${displayId} eliminado`);
  render();
}

async function deleteAnalisis(id) {
  const analisis = currentData.analisis.find(a => a.id === id);
  if (!confirm(`¬øEliminar an√°lisis "${analisis.nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) return;
  
  if (db) {
    await db.collection('analisis').doc(id).delete();
  } else {
    const all = JSON.parse(localStorage.getItem('analisis') || '[]');
    localStorage.setItem('analisis', JSON.stringify(all.filter(a => a.id !== id)));
  }
  
  currentData.analisis = currentData.analisis.filter(a => a.id !== id);
  alert('‚úÖ An√°lisis eliminado');
  render();
}

function showBatchAnalysisModal() {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const framework = currentData.frameworks.find(f => f.id === analisis.frameworkId);
  
  if (!analisis.documentos || analisis.documentos.length === 0) {
    return alert('‚ö†Ô∏è Primero debes subir documentos para poder analizar');
  }
  
  // Contar pendientes
  const totalIndicaciones = framework.categorias.reduce((sum, cat) => 
    sum + cat.elementos.reduce((s, elem) => s + elem.indicaciones.length, 0), 0
  );
  const completadas = (analisis.respuestas || []).length;
  const pendientes = totalIndicaciones - completadas;
  
  if (pendientes === 0) {
    return alert('‚úÖ No hay indicaciones pendientes.\n\nTodas las indicaciones ya han sido analizadas.');
  }
  
  // Calcular estimaciones
  const avgTokensPerDoc = analisis.documentos.reduce((sum, d) => sum + estimateTokens(d.contenido || ''), 0);
  const estimatedTokensPerAnalysis = avgTokensPerDoc + 500;
  const totalTokens = estimatedTokensPerAnalysis * pendientes;
  const estimatedCost = calculateCost(totalTokens, pendientes * 500);
  const estimatedMinutes = Math.ceil(pendientes * 0.25); // 15 seg por an√°lisis
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>üöÄ An√°lisis por Lotes</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body">
        <div class="cost-alert" style="background:#fef3c7;border:2px solid #f59e0b;padding:1.5rem;border-radius:0.5rem;margin-bottom:1.5rem;">
          <h3 style="margin-bottom:1rem;">‚ö†Ô∏è ATENCI√ìN: Proceso largo y costoso</h3>
          
          <p style="margin-bottom:0.5rem;"><strong>Indicaciones pendientes:</strong> ${pendientes}</p>
          <p style="margin-bottom:0.5rem;"><strong>Tiempo estimado:</strong> ~${estimatedMinutes} minutos</p>
          <p style="margin-bottom:0.5rem;"><strong>Tokens estimados:</strong> ~${totalTokens.toLocaleString()}</p>
          <p style="margin-bottom:1rem;"><strong>Costo estimado:</strong> ${formatCost(estimatedCost.total)}</p>
          
          <p style="font-size:0.875rem;color:#92400e;margin-bottom:0.5rem;">
            ‚Ä¢ Se analizar√° autom√°ticamente una indicaci√≥n cada 15 segundos
          </p>
          <p style="font-size:0.875rem;color:#92400e;margin-bottom:0.5rem;">
            ‚Ä¢ Puedes pausar o detener el proceso en cualquier momento
          </p>
          <p style="font-size:0.875rem;color:#92400e;margin-bottom:0.5rem;">
            ‚Ä¢ Se usar√°n TODOS los documentos subidos para cada an√°lisis
          </p>
          <p style="font-size:0.875rem;color:#92400e;">
            ‚Ä¢ El progreso se guarda autom√°ticamente
          </p>
        </div>
        
        <div class="flex gap-2">
          <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
          <button class="btn btn-primary" onclick="startBatchAnalysis(${pendientes})">
            üöÄ Iniciar An√°lisis (${formatCost(estimatedCost.total)})
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

let batchAnalysisRunning = false;
let batchAnalysisPaused = false;

async function startBatchAnalysis(totalPendientes) {
  closeModal();
  
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const framework = currentData.frameworks.find(f => f.id === analisis.frameworkId);
  
  // Recopilar todas las indicaciones pendientes
  const pendingItems = [];
  framework.categorias.forEach(cat => {
    cat.elementos.forEach(elem => {
      elem.indicaciones.forEach(ind => {
        const resp = (analisis.respuestas || []).find(r => r.indicacionId === ind.id);
        if (!resp) {
          pendingItems.push({
            catId: cat.id,
            catNombre: cat.nombre,
            elemId: elem.id,
            elemNombre: elem.nombre,
            indId: ind.id,
            indTexto: ind.texto
          });
        }
      });
    });
  });
  
  batchAnalysisRunning = true;
  batchAnalysisPaused = false;
  
  // Mostrar modal de progreso
  const progressModal = document.createElement('div');
  progressModal.className = 'modal-overlay';
  progressModal.id = 'batch-progress-modal';
  progressModal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>ü§ñ An√°lisis por Lotes en Progreso</h2>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:1rem;">
          <p><strong>Progreso:</strong> <span id="batch-current">0</span> / ${pendingItems.length} completadas</p>
          <div style="background:#e5e7eb;height:20px;border-radius:10px;overflow:hidden;margin:0.5rem 0;">
            <div id="batch-progress-bar" style="background:#111827;height:100%;width:0%;transition:width 0.3s;"></div>
          </div>
          <p style="text-align:center;font-weight:600;" id="batch-percent">0%</p>
        </div>
        
        <div style="background:#f9fafb;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <p class="text-sm" id="batch-current-item">Preparando...</p>
          <p class="text-sm text-gray mt-2" id="batch-next-in">Siguiente an√°lisis en: --</p>
        </div>
        
        <div class="flex gap-2">
          <button class="btn btn-secondary" id="batch-pause-btn" onclick="toggleBatchPause()">‚è∏Ô∏è Pausar</button>
          <button class="btn btn-secondary" onclick="stopBatchAnalysis()">‚èπÔ∏è Detener</button>
        </div>
        
        <p class="text-xs text-gray mt-4">üí° Puedes cerrar esta ventana, el proceso continuar√° en segundo plano</p>
      </div>
    </div>
  `;
  document.body.appendChild(progressModal);
  
  // Procesar cada indicaci√≥n
  for (let i = 0; i < pendingItems.length && batchAnalysisRunning; i++) {
    const item = pendingItems[i];
    
    // Actualizar UI
    document.getElementById('batch-current').textContent = i;
    document.getElementById('batch-current-item').textContent = `Analizando: ${item.catNombre} > ${item.elemNombre}`;
    const percent = Math.round((i / pendingItems.length) * 100);
    document.getElementById('batch-percent').textContent = `${percent}%`;
    document.getElementById('batch-progress-bar').style.width = `${percent}%`;
    
    // Esperar si est√° pausado
    while (batchAnalysisPaused && batchAnalysisRunning) {
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    if (!batchAnalysisRunning) break;
    
    try {
      // Analizar
      const allDocs = analisis.documentos.map(d => d.displayId);
      const result = await analyzeWithMistral(item.indTexto, analisis.documentos, allDocs, analisis.temperature);
      
      const newResp = {
        id: `resp-${Date.now()}-${i}`,
        categoriaId: item.catId,
        elementoId: item.elemId,
        indicacionId: item.indId,
        propuestaIA: result.propuestaRespuesta,
        respuestaFinal: '',
        gaps: result.gapsDetectados,
        referencias: result.referencias,
        confianza: result.confianza,
        documentosUsados: allDocs,
        tokensUsados: result.tokensUsados,
        costo: result.costo,
        status: 'completado',
        analyzedAt: new Date()
      };
      
      if (!analisis.respuestas) analisis.respuestas = [];
      analisis.respuestas.push(newResp);
      await DataStore.saveAnalisis(analisis);
      
    } catch (error) {
      console.error(`Error analizando ${item.indTexto}:`, error);
      // Continuar con la siguiente
    }
    
    // Delay de 15 segundos entre an√°lisis (evitar rate limit)
    if (i < pendingItems.length - 1 && batchAnalysisRunning) {
      for (let sec = 15; sec > 0 && batchAnalysisRunning && !batchAnalysisPaused; sec--) {
        document.getElementById('batch-next-in').textContent = `Siguiente an√°lisis en: ${sec} segundos`;
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }
  }
  
  // Finalizar
  batchAnalysisRunning = false;
  document.getElementById('batch-current').textContent = pendingItems.length;
  document.getElementById('batch-percent').textContent = '100%';
  document.getElementById('batch-progress-bar').style.width = '100%';
  document.getElementById('batch-current-item').textContent = '‚úÖ An√°lisis completado';
  document.getElementById('batch-next-in').textContent = '';
  document.getElementById('batch-pause-btn').style.display = 'none';
  
  setTimeout(() => {
    closeModal();
    alert(`‚úÖ An√°lisis por lotes completado\n\n${pendingItems.length} indicaciones analizadas`);
    render();
  }, 2000);
}

function toggleBatchPause() {
  batchAnalysisPaused = !batchAnalysisPaused;
  const btn = document.getElementById('batch-pause-btn');
  if (batchAnalysisPaused) {
    btn.innerHTML = '‚ñ∂Ô∏è Reanudar';
    document.getElementById('batch-next-in').textContent = 'Pausado...';
  } else {
    btn.innerHTML = '‚è∏Ô∏è Pausar';
  }
}

function stopBatchAnalysis() {
  if (confirm('¬øDetener el an√°lisis por lotes?\n\nEl progreso actual se ha guardado.')) {
    batchAnalysisRunning = false;
    closeModal();
    render();
  }
}

function applyFilters() {
  const searchText = document.getElementById('search-text')?.value.toLowerCase() || '';
  const filterStatus = document.getElementById('filter-status')?.value || 'all';
  const filterConfidence = document.getElementById('filter-confidence')?.value || 'all';
  
  const items = document.querySelectorAll('.analysis-item');
  let visibleCount = 0;
  let totalCount = items.length;
  
  items.forEach(item => {
    let show = true;
    
    // Filtro de b√∫squeda
    if (searchText && !item.dataset.searchText.includes(searchText)) {
      show = false;
    }
    
    // Filtro de estado
    if (filterStatus !== 'all' && item.dataset.status !== filterStatus) {
      show = false;
    }
    
    // Filtro de confianza
    if (filterConfidence !== 'all') {
      const conf = parseInt(item.dataset.confidence);
      if (filterConfidence === 'high' && conf < 80) show = false;
      if (filterConfidence === 'medium' && (conf < 50 || conf >= 80)) show = false;
      if (filterConfidence === 'low' && conf >= 50) show = false;
    }
    
    // Mostrar/ocultar elemento y su contenedor padre
    if (show) {
      item.style.display = '';
      visibleCount++;
    } else {
      item.style.display = 'none';
    }
  });
  
  // Ocultar categor√≠as vac√≠as
  document.querySelectorAll('.card').forEach(card => {
    const visibleItems = Array.from(card.querySelectorAll('.analysis-item')).filter(item => item.style.display !== 'none');
    if (visibleItems.length === 0 && card.querySelector('.analysis-item')) {
      card.style.display = 'none';
    } else if (card.querySelector('.analysis-item')) {
      card.style.display = '';
    }
  });
  
  // Mostrar resultado
  const resultsDiv = document.getElementById('filter-results');
  if (resultsDiv) {
    if (searchText || filterStatus !== 'all' || filterConfidence !== 'all') {
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = `üìä Mostrando <strong>${visibleCount}</strong> de <strong>${totalCount}</strong> indicaciones`;
    } else {
      resultsDiv.style.display = 'none';
    }
  }
}

function clearFilters() {
  document.getElementById('search-text').value = '';
  document.getElementById('filter-status').value = 'all';
  document.getElementById('filter-confidence').value = 'all';
  applyFilters();
}


function showBibliografia() {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>üìö Bibliograf√≠a del An√°lisis</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body">
        ${(analisis.documentos || []).length === 0 ? `
          <p class="text-gray text-center">No hay documentos en este an√°lisis</p>
        ` : `
          <p class="text-sm text-gray mb-4">Total de documentos: ${analisis.documentos.length}</p>
          ${analisis.documentos.map(doc => `
            <div class="biblio-item">
              <p><strong>${doc.displayId}:</strong> ${doc.nombre}</p>
              <p class="text-sm text-gray">
                üìÑ ${doc.paginas} p√°ginas ‚Ä¢ 
                üíæ ${(doc.tama√±o / 1024).toFixed(1)} KB ‚Ä¢ 
                üìÖ ${new Date(doc.uploadedAt).toLocaleDateString('es-ES')}
              </p>
            </div>
          `).join('')}
        `}
        <button class="btn btn-secondary mt-4" onclick="closeModal()">Cerrar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function showStats() {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const framework = currentData.frameworks.find(f => f.id === analisis.frameworkId);
  
  const respuestas = analisis.respuestas || [];
  const totalIndicaciones = framework.categorias.reduce((sum, cat) => 
    sum + cat.elementos.reduce((s, elem) => s + elem.indicaciones.length, 0), 0
  );
  
  const completadas = respuestas.length;
  const revisadas = respuestas.filter(r => r.status === 'revisado').length;
  const pendientes = totalIndicaciones - completadas;
  
  const highConf = respuestas.filter(r => r.confianza >= 0.8).length;
  const medConf = respuestas.filter(r => r.confianza >= 0.5 && r.confianza < 0.8).length;
  const lowConf = respuestas.filter(r => r.confianza < 0.5).length;
  
  const totalTokens = respuestas.reduce((sum, r) => sum + (r.tokensUsados || 0), 0);
  const totalCost = respuestas.reduce((sum, r) => sum + (r.costo || 0), 0);
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>üìä Estad√≠sticas del An√°lisis</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body">
        <div class="card" style="margin-bottom:1rem;">
          <h3>Progreso</h3>
          <p class="text-sm">Total de indicaciones: <strong>${totalIndicaciones}</strong></p>
          <p class="text-sm">‚úÖ Completadas: <strong>${completadas}</strong> (${Math.round(completadas/totalIndicaciones*100)}%)</p>
          <p class="text-sm">üëÅÔ∏è Revisadas: <strong>${revisadas}</strong></p>
          <p class="text-sm">‚è≥ Pendientes: <strong>${pendientes}</strong></p>
        </div>
        
        <div class="card" style="margin-bottom:1rem;">
          <h3>Confianza</h3>
          <p class="text-sm">üü¢ Alta confianza (‚â•80%): <strong>${highConf}</strong></p>
          <p class="text-sm">üü° Media confianza (50-79%): <strong>${medConf}</strong></p>
          <p class="text-sm">üî¥ Baja confianza (<50%): <strong>${lowConf}</strong></p>
        </div>
        
        <div class="card">
          <h3>Uso de IA</h3>
          <p class="text-sm">üî§ Tokens usados: <strong>${totalTokens.toLocaleString()}</strong></p>
          <p class="text-sm">üí∞ Costo total: <strong>${formatCost(totalCost)}</strong></p>
          <p class="text-sm">üå°Ô∏è Temperatura: <strong>${analisis.temperature || 0.3}</strong></p>
        </div>
        
        <button class="btn btn-secondary mt-4" onclick="closeModal()">Cerrar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function viewDocContent(displayId) {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const doc = analisis.documentos.find(d => d.displayId === displayId);
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>üëÅÔ∏è Contenido: ${doc.displayId} - ${doc.nombre}</h2>
        <button onclick="closeModal()" class="btn btn-secondary btn-sm">‚ùå</button>
      </div>
      <div class="modal-body">
        <p class="text-sm text-gray mb-4">
          üìÑ ${doc.paginas} p√°ginas ‚Ä¢ 
          ${(doc.contenido.length / 1024).toFixed(1)} KB de texto extra√≠do
        </p>
        <div style="max-height:400px;overflow-y:auto;padding:1rem;background:#f9fafb;border-radius:0.5rem;font-size:0.875rem;line-height:1.5;">
          <pre style="white-space:pre-wrap;font-family:system-ui;">${doc.contenido.substring(0, 5000)}${doc.contenido.length > 5000 ? '\n\n... (texto truncado para visualizaci√≥n)' : ''}</pre>
        </div>
        <button class="btn btn-secondary mt-4" onclick="closeModal()">Cerrar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function exportAnalysis() {
  const analisis = currentData.analisis.find(a => a.id === currentData.currentAnalisisId);
  const framework = currentData.frameworks.find(f => f.id === analisis.frameworkId);
  
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Generando...';
  
  try {
    await exportToWord(analisis, framework);
  } finally {
    btn.disabled = false;
    btn.textContent = '‚¨áÔ∏è Exportar Word';
  }
}

function closeModal() {
  const modal = document.querySelector('.modal-overlay');
  if (modal) modal.remove();
}

// ============================================================
// INIT
// ============================================================

async function init() {
  const app = document.getElementById('app');
  app.innerHTML = '<div class="container"><div class="loader"></div><p class="text-center text-gray mt-4">Cargando aplicaci√≥n...</p></div>';
  
  try {
    const [frameworks, analisis] = await Promise.all([
      DataStore.getFrameworks(),
      DataStore.getAnalisis()
    ]);
    
    currentData.frameworks = frameworks;
    currentData.analisis = analisis;
    
    render();
    console.log('‚úÖ Aplicaci√≥n iniciada');
    console.log('üìä Frameworks:', frameworks.length);
    console.log('üìä An√°lisis:', analisis.length);
  } catch (error) {
    console.error('Error al iniciar:', error);
    app.innerHTML = `
      <div class="container" style="text-align:center;padding:4rem 1rem;">
        <h1 style="color:#ef4444;">‚ùå Error al cargar</h1>
        <p class="text-gray mt-4">${error.message}</p>
        <button class="btn btn-primary mt-4" onclick="location.reload()">üîÑ Reintentar</button>
      </div>
    `;
  }
}

// Start
document.addEventListener('DOMContentLoaded', init);
if (document.readyState === 'complete') init();

  </script>
</body>
</html>

